\documentclass[a5paper,10pt]{article}

%\usepackage{showframe}

\usepackage[utf8]{inputenc}
\usepackage[spanish]{babel}
\usepackage[T1]{fontenc}
\usepackage[]{times}
\usepackage[linkcolor=blue,urlcolor=blue,colorlinks=true]{hyperref}
\usepackage{graphicx}
%\usepackage{subcaption}
\usepackage{listingsutf8}
\usepackage[dvipsnames]{xcolor}

\addtolength{\voffset}{-2cm}
\addtolength{\textheight}{4cm}

% Se incluyen formatos redifinidos para paquete listings
\input{Lenguajes.tex}


\author{Maximiliano A. Eschoyez}
\title{ANTLR en Visual Studio Code}
\date{2021}

\begin{document}
%\ebook
\maketitle

%\tableofcontents

\begin{abstract}
	Esta guía tiene como fin explicar la utilización de ANTLR en la IDE Visual Studio Code y con Maven como gestor de proyecto.  Se explican los pasos mínimos desde la instalación de ANTLR Java hasta la compilación de código fuente y la generación de diferentes gráficos de análisis.
\end{abstract}

\section{Preparando el Entorno de Trabajo}
\label{intro}

Para desarrollar los contenidos de la asignatura, vamos a trabajar con ANTLR y Java en la IDE Visual Studio Code.  Los proyectos de software los gestionaremos con Maven y usaremos Git para versionado y repositorio.

A continuación se explica brevemente como instalar las diferentes herramientas.  No hace falta instalar Git ya que las funcionalidades necesarias se encuentran disponibles en Visual Studio Code.

\subsection{Java}
\label{Java}

Como herramienta base, vamos a necesitar el \emph{Java Developer Kit (JDK)} versión 11. Pueden descargarlo desde la página de \href{https://www.oracle.com/java/technologies/javase-downloads.html}{Oracle} o utilizar \href{https://openjdk.java.net/}{OpenJDK}, que normalmente se instala con el gestor de paquetes del sistema operativo.


\subsection{Visual Studio Code}
\label{vscode}

Como herramienta de desarrollo vamos a utilizar la IDE \href{https://code.visualstudio.com/}{Visual Studio Code}.  Para distribuciones Lixux, es conveniente utilizar el gestor de paquetes apropiado (Ej. \href{https://wiki.debian.org/VisualStudioCode}{para Debian}).  Luego, debemos instalar los \emph{plug--in} necesarios para trabajar:
\begin{enumerate}
	\item \hyperref[pluginJava]{Java}
	\item \hyperref[pluginMaven]{Maven}
	\item \hyperref[pluginANTLR]{ANTLR}
\end{enumerate}

\subsection{Java \emph{plug--in}}
\label{pluginJava}

El \emph{plug--in} \href{https://marketplace.visualstudio.com/items?itemName=vscjava.vscode-java-pack}{Java Extension Pack} instala todo lo necesario para trabajar con el lenguaje Java.

\subsection*{Instalación del \emph{plug--in}}
\label{instalacionJava}

La instalación se puede realizar de dos formas:
\begin{enumerate}
	\item con el atajo de teclado \verb|Ctl+Shift+x| o \emph{clickeando} el ícono \emph{Extensions} y buscándolo, o
    \item con el atajo de teclado \verb|Ctl+p| para ejecutar en el \emph{VS Code Quick Open} el comando
    \begin{verbatim}
		ext install vscjava.vscode-java-pack
	\end{verbatim}
\end{enumerate}


\subsection{Maven \emph{plug--in}}
\label{pluginMaven}

El \emph{plug--in} \href{https://marketplace.visualstudio.com/items?itemName=vscjava.vscode-maven}{Mave for Java} debería instalarse automáticamente al instalar el Java Extension Pack.  Si por algún motivo no se instaló, hacerlo manualmente.


\subsection{ANTLR \emph{plug--in}}
\label{pluginANTLR}

En la \href{https://www.antlr.org/tools.html}{página web de ANTLR} se pueden encontrar los \emph{plug--in} para diferentes IDEs.

\begin{figure}[b]
	\centering
	\includegraphics[width=3cm]{img/IconoANTLRvscode}
	\caption{ANTLR4 grammar syntax support -- Mike Lischke}
	\label{icono}
\end{figure}

Si bien en Visual Studio Code existen varias herramientas para ANTLR, vamos a utilizar el \emph{plug--in} de Mike Lischke \href{https://marketplace.visualstudio.com/items?itemName=mike-lischke.vscode-antlr4}{ANTLR4 grammar syntax support}~(Figura~\ref{icono}).

El \emph{plug--in} completo se encuentra publicado con acceso libre en GitHub.  Este documento se basa en la documentación del \href{https://github.com/mike-lischke/vscode-antlr4/tree/master/doc}{\emph{plug--in ANTLR}}.


\subsection*{Instalación del \emph{plug--in}}
\label{instalacionANTLR}

La instalación se puede realizar de dos formas:
\begin{enumerate}
	\item con el atajo de teclado \verb|Ctl+Shift+x| o \emph{clickeando} el ícono \emph{Extensions} y buscándolo, o
    \item con el atajo de teclado \verb|Ctl+p| para ejecutar en el \emph{VS Code Quick Open} el comando
    \begin{verbatim}
		ext install mike-lischke.vscode-antlr4
	\end{verbatim}
\end{enumerate}

% \begin{center}
% 	\fbox{
% 		\parbox{.9\textwidth}{\textbf{NOTA}: La biblioteca ANTLR \emph{complete} debe estar en el sistema o incluir el \texttt{.jar} en el proyecto para ejecutar el programa.}
% 	}	
% \end{center}


\section{¿Cómo vamos a trabajar?}

Vamos trabajar dentro de un proyecto Java de tipo Maven, por lo tanto, es necesario instalar soporte Java, particularmente el \emph{plug--in \textbf{Maven for Java}} (\verb|vscjava.vscode-maven|).  Para más información, ver la documentación \href{https://code.visualstudio.com/docs/java/java-project}{\emph{Java Project Management in VS Code}} de la página de Visual Studio Code.

\begin{figure}[p]
	\centering
	\includegraphics[width=.95\textwidth]{img/SelectJSON}
	\caption{Acceso a la configuración (archivo \texttt{settings.json}).}
	\label{preferences}
\end{figure}

Para simplificar la generación del software, vamos a colocar todos los archivos \verb|.java| en el mismo paquete que la aplicación.  Igualmente, algunos archivos de salida de ANTLR se guardarán en la carpeta \verb|.antlr|.  Para modificar el archivo \verb|settings.json|, se puede acceder de varias formas, pero la más simple es siguiendo estos pasos:
\begin{enumerate}
	\item Abrir el \emph{Command Palette} con \verb|Ctl+Shift+P|,
	\item Buscar la opción \emph{Preferences: Open Settings (JSON)} y seleccionarla (Figura~\ref{preferences}),
	\item Agregar las siguientes líneas de código
	\begin{lstlisting}[style=miJSON]
	"antlr4.generation.mode": "external",
	"antlr4.generation.visitors": true
	\end{lstlisting}
\end{enumerate}
Hay que tener en cuenta que la coma es el separador en JSON y no debe faltar.  Además, las líneas de código deben estar antes de la llave de cierre como en el ejemplo del Código~\ref{settings}.

\lstinputlisting[float,style=miJSON,caption={Ejemplo de archivo \texttt{code/settings.json}.},label=settings]{code/settings.json}

Si no incluimos el \verb|.jar| de ANTLR en el proyecto, debemos configurar el proyecto para que se pueda utilizar la biblioteca del sistema.  En el archivo \verb|.classpath| debemos agregar la línea
\begin{lstlisting}[style=miXML]
<classpathentry kind="lib"
    path="/usr/share/java/antlr-4.x.x-complete.jar" />	
\end{lstlisting}
donde \verb|"/usr/share/java/antlr-4.x.x-complete..jar"| es para Debian~9 y deben reemplazarla por lo que corresponda.  El archivo de ejemplo completo puede verse en el Código~\ref{classpath}.

\lstinputlisting[float,style=miXML,caption={Ejemplo de archivo \texttt{.classpath}.},label=classpath]{code/classpath}


\section{Primer Proyecto}
\label{primerproyecto}

Ya instalados y configurados los \emph{plug--ins} necesarios, podemos comenzar el primer proyecto.

\subsection{Crear Proyecto Java}
\label{proyecto_java}

\begin{figure}[t]
	\centering
	\includegraphics[width=.95\textwidth]{img/NuevoProyecto}
	\caption{Nuevo proyecto Java.}
	\label{maven_nuevo}
\end{figure}


El primer paso es crear un proyecto Java.  Para esto, se puede acceder al \emph{Command Palette} con el atajo \verb|Ctl+Shift+P|, escribir la palabra \emph{project} y elegir la opción ``\emph{Java: Create Java Project}'' (Fig.~\ref{maven_nuevo}). Luego, elegir la carpeta destino y darle nombre al proyecto.  Al finalizar estos pasos, tendremos un proyecto Java con un paquete por defecto denominado \verb|App|.  El archivo \verb|app.java| contiente el método \verb|main()| y está listo para compilar y ejecutar.


\begin{figure}[t]
	\centering
	\includegraphics[width=.95\textwidth]{img/PrimerCompilacion}
	\caption{Elegir Java para compilar.}
	\label{java_project}
\end{figure}

\begin{figure}[t]
	\centering
	\includegraphics[width=.95\textwidth]{img/PrimeraEjecucion}
	\caption{Ejecutar el proyecto Java.}
	\label{hello_java}
\end{figure}


Recordemos que Visual Studio Code está pensado para desarrollar software, por lo tanto, cuando querramos ejecutar nuestro software vamos a hacerlo sobre el \emph{debugger}.  La ejecución se realiza presionando \verb|F5|.  La primera ejecución del proyecto necesita que se configuren parámetros de compilación qué, para nuestro caso, será suficiente con las configuraciones por defecto.  Al presionar \verb|F5| por primera vez debemos elegir ``Java'' como tipo de proyecto  (Fig.~\ref{java_project}).  Esta acción crea y abre el archivo de configuración \verb|launch.json| en la carpeta \verb|.vscode| del proyecto.  Si presionamos nuevamente \verb|F5| se ejecutará el proyecto y veremos que se abre el panel del \emph{debugger} y se muestra la salida por la \emph{debug console} con el texto ``\emph{Hello Java}'' (Fig.~\ref{hello_java}).  Las próximas veces se ejecutará nuestro programa sin necesidad de realizar configuraciones adicionales.

Finalmente, es necesario modificar el archivo \verb|launch.json| para habilitar la visualización del árbol sintáctico (para más información ver la guía del \emph{plug--in} ANTLR \href{https://github.com/mike-lischke/vscode-antlr4/blob/master/doc/grammar-debugging.md}{\emph{Debugging ANTLR4 grammars}}).  Se debe agregar a la lista de opciones la entrada del Código~\ref{launch_json_antlr}.

\lstinputlisting[float,style=miJSON,caption={Entrada en archivo \texttt{settings.json} para ANTLR.},label=launch_json_antlr]{code/launchJsonAntlr.json}

Para el correcto funcionamiento de ANTLR en nuestro proyecto es necesario ajustar del Código~\ref{launch_json_antlr} las entradas:
\begin{description}
	\item[\texttt{input}] el archivo de entrada a \emph{parsear},
	\item[\texttt{startRule}] el símbolo inicial,
	\item[\texttt{grammar}] (opcional) el archivo ANTLR con las reglas gramaticales,
	\item[\texttt{actionFile}] (opcional) ver documentación.
\end{description}

\subsection{Crear Proyecto Java con Maven}
\label{proyecto_maven}



\href{https://maven.apache.org/}{sitio web de Maven}

\href{https://maven.apache.org/guides/getting-started/maven-in-five-minutes.html}{guía rápida sobre Maven}


\subsection{Archivo ANTLR}
\label{archivo_antlr}

Con el proyecto Java creado y listo para trabajar vamos a crear el archivo para ANTLR. Los archivos de ANTLR llevan extensión \verb|.g| o \verb|.g4|, pero utilizaremos la segunda opción.  El atajo de teclado para crear un archivo vacío es \verb|Ctl+n|, que para hacer efectivo el coloreo hay que guardarlo (\verb|Ctl+s|) con la extensión apropiada.

ANTLR permite la generación del \emph{lexer} y del \emph{parser}.  Por lo tanto, los archivos \verb|.g4| pueden ser para el primero, el segundo o ambos combinados.  Nosotros utilizaremos archivos combinados dentro del paquete que contiene el método \verb|main()| para facilitar la ejecución y visualización de resultados.  En particular, en el proyecto ejemplo guardaremos el archivo \verb|.g4| en la carpeta \verb|src/app/|.


\subsection{Ejemplo Archivo ANTLR}
\label{ejemplo_archivo_antlr}

% ,style=editor
\lstinputlisting[float,style=miANTLR,caption={Ejemplo de archivo \texttt{.g4}.},label=id_g4]{code/id.g4}

A modo de ejemplo, el Código~\ref{id_g4} es un archivo \verb|.g4| que realiza la búsqueda de identificadores tipo Java (nombres de variable o de método).  Tanto las reglas léxicas como las gramaticales comienzan con el identificador o etiqueta y terminan en punto y como (\verb|;|).  Los dos puntos (\verb|:|) indican el comienzo de la regla y la barra vertical o \emph{pipe} (\verb-|-) separan las distintas reglas alternativas.  Las expresiones regulares para la detección de \emph{tokens} se etiquetan con nombres en mayúsculas, como ser \verb|ID| en la línea~10.  Las reglas gramaticales se etiquetan con nombres en minúsculas, como ser \verb|s|.

Las palabras reservadas del Código~\ref{id_g4} significan lo siguiente:
\begin{description}
	\item[\texttt{grammar}] Al comienzo del archivo (línea~1) se indica qué queremos generar, siendo \verb|grammar| la palabra reservada tanto para un \emph{parser} como para un archivo combinado. La otra alternativa sería \verb|lexer|.  La palabra \verb|id| es el nombre del \emph{parser}.
	\item[\texttt{@header}] En la línea~3 se utiliza el bloque indicado como \verb|@header| para colocar código fuente en Java que necesitamos que aparezca en todos los código fuente generados por ANTLR.  En el ejemplo se consigna solamente el \verb|package| al que pertenecen.
	\item[\texttt{fragment}] En las líneas~7 y~8 la palabra \verb|fragment| indica que la expresión regular se utilizará para construir expresiones regulares más complejas, por lo tanto, no se utiliza durante el análisis léxico.
\end{description}

Cada vez que se grabe el archivo en disco, el \emph{plug--in} de ANTLR regenerará todos los archivos.


\end{document}
